
version: '3.8'
services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: nexus
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: nexus_os
    ports: ["5432:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  api:
    build: ./backend
    environment:
      DATABASE_URL: postgres://nexus:dev_password@db:5432/nexus_os
      REDIS_URL: redis://redis:6379
      API_KEY: ${API_KEY} # Injected from .env
    ports: ["5002:5002"]
    depends_on: [db, redis]

  worker:
    build: ./backend # Reuses backend codebase for worker logic
    command: npm run worker # Assumes 'worker' script in package.json
    environment:
      DATABASE_URL: postgres://nexus:dev_password@db:5432/nexus_os
      REDIS_URL: redis://redis:6379
      API_KEY: ${API_KEY}
    depends_on: [db, redis]

  frontend:
    build: . # Assumes frontend in root or adjust context
    ports: ["3000:3000"]
    environment:
      REACT_APP_API_URL: http://localhost:5002/api

volumes:
  pgdata:
